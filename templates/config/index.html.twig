{% extends 'base.html.twig' %}

{% block title %}Settings - AllDebridDL{% endblock %}

{% block body %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h2>Configuration</h2>
    <form method="post">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Global Settings -->
            <section>
                <h3 style="color: var(--accent); margin-bottom: 1rem;">Global Settings</h3>
                <div style="margin-bottom: 1rem;">
                    <label for="api_key">Alldebrid API Key</label>
                    <input type="text" id="api_key" name="api_key" value="{{ config.api_key|default('') }}" placeholder="Enter your API Key" required>
                    <small style="color: var(--text-secondary);">Your personal Alldebrid API token.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="grok_api_key">Grok AI API Key (xAI)</label>
                    <input type="text" id="grok_api_key" name="grok_api_key" value="{{ config.grok_api_key|default('') }}" placeholder="xai-...">
                    <small style="color: var(--text-secondary);">Used for AI-assisted file renaming.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="grok_model">Grok Model</label>
                    <input type="text" id="grok_model" name="grok_model" value="{{ config.grok_model|default('grok-4-fast-non-reasoning') }}" placeholder="grok-...">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label for="default_path">Default Torrent Path</label>
                    <input type="text" id="default_path" name="default_path" value="{{ config.default_path|default('') }}" placeholder="C:\Users\Downloads\Torrents" required>
                    <small style="color: var(--text-secondary);">Where torrent files are saved by default.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="grok_renaming_prompt">AI Renaming Prompt</label>
                    <textarea id="grok_renaming_prompt" name="grok_renaming_prompt" style="width:100%; height:200px; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white; font-family:monospace; font-size:0.8rem;">{{ config.grok_renaming_prompt|default(
"1. Use the CONTEXT to identify the Category (Movie, Series, Music, Ebook), Title, and metadata (Season, Year, Artist, Album).
2. Standardize filenames based on category:
   - Series: \"Showname.SxxExx.OptionalTitle.ext\".
   - Anime: \"Showname.SxxExx.OptionalTitle.ext\".
   - Movies: \"Movie Name (Year).ext\".
   - Music: \"XX - Song Name.ext\" (XX = track number, identify from filename).
   - Ebooks: \"Clean Book Title.ext\".
3. Identify episode/track numbers from individual filenames (e.g., \"01.mkv\" is Episode 1).
4. Rules for \"path\":
   - Series: \"Video/TV Shows/Series Name/Season XX/\" (e.g. \"Video/TV Shows/The Sopranos/Season 02/\").
   - Anime: \"Video/Anime/Series Name/Season XX/\" (e.g. \"Video/Anime/Naruto/Season 01/\").
   - Movies: \"Video/Movies/Movie Name (Year)/\" (e.g. \"Video/Movies/Inception (2010)/\").
   - Music: \"Music/Artist Name/Album Name/\" (e.g. \"Music/Pink Floyd/The Wall/\").
   - Ebooks: \"Ebooks/Series Name/\" or \"Ebooks/Author Name/\" (e.g. \"Ebooks/Harry Potter/\"). use a T in front of the volume number when required. Only keep the name of the book (and the series if there is one) in the filename.
5. Return a JSON object where keys are ORIGINAL filenames and values are another JSON object containing \"filename\" and \"path\".
6. For ebooks NEVER change the language of the book title.
7. Maintain the exact original file extension.") }}</textarea>
                    <small style="color: var(--text-secondary);">System instructions for Grok regarding file renaming and path generation.</small>
                </div>

                <h3 style="color: var(--accent); margin: 2rem 0 1rem 0;">Spotify API (Metadata)</h3>
                <div style="margin-bottom: 1rem;">
                    <label for="spotify_client_id">Spotify Client ID</label>
                    <input type="text" id="spotify_client_id" name="spotify_client_id" value="{{ config.spotify_client_id|default('') }}" placeholder="Enter Client ID">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="spotify_client_secret">Spotify Client Secret</label>
                    <input type="password" id="spotify_client_secret" name="spotify_client_secret" value="{{ config.spotify_client_secret|default('') }}" placeholder="Enter Client Secret">
                    <small style="color: var(--text-secondary);">Required for real-time track metadata extraction.</small>
                </div>

                <h3 style="color: var(--accent); margin: 2rem 0 1rem 0;">App Security üîê</h3>
                <div style="margin-bottom: 1rem;">
                    <label for="admin_user">Username</label>
                    <input type="text" id="admin_user" name="admin_user" value="{{ config.admin_user|default('admin') }}" required>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="admin_password">Password</label>
                    <input type="password" id="admin_password" name="admin_password" value="{{ config.admin_password|default('admin') }}" required>
                    <small style="color: var(--text-secondary);">Used to secure your dashboard.</small>
                </div>
            </section>

            <!-- Music Settings -->
            <section>
                <h3 style="color: var(--accent); margin-bottom: 1rem;">Music Downloader</h3>
                
                <div style="margin-bottom: 1rem;">
                    <label for="music_venv_path">Venv Path (Relative)</label>
                    <input type="text" id="music_venv_path" name="music_venv_path" value="{{ config.music_venv_path|default('venv') }}">
                    <small style="color: var(--text-secondary);">Path to python virtual environment folder.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_binary">Music Command Binary</label>
                    <input type="text" id="music_binary" name="music_binary" value="{{ config.music_binary|default('musicdownload') }}">
                    <small style="color: var(--text-secondary);">The command to run (e.g., spotdl, musicdownload).</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_root_path">Music Download Root</label>
                    <input type="text" id="music_root_path" name="music_root_path" value="{{ config.music_root_path|default('') }}">
                    <small style="color: var(--text-secondary);">Base directory for music files.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_output">Output Template</label>
                    <input type="text" id="music_output" name="music_output" value="{{ config.music_output|default('{artist} - {album} - {song_name}.{ext}') }}">
                    <small style="color: var(--text-secondary);">Filename format. Use tags like {artist}, {song_name}.</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label for="music_format">Format</label>
                        <select id="music_format" name="music_format" style="width:100%; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white;">
                            <option value="mp3" {{ config.music_format|default('mp3') == 'mp3' ? 'selected' : '' }}>MP3</option>
                            <option value="flac" {{ config.music_format|default('mp3') == 'flac' ? 'selected' : '' }}>FLAC</option>
                            <option value="m4a" {{ config.music_format|default('mp3') == 'm4a' ? 'selected' : '' }}>M4A</option>
                            <option value="opus" {{ config.music_format|default('mp3') == 'opus' ? 'selected' : '' }}>OPUS</option>
                        </select>
                    </div>
                    <div>
                        <label for="music_quality">Quality</label>
                        <select id="music_quality" name="music_quality" style="width:100%; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white;">
                            <option value="very_high" {{ config.music_quality|default('very_high') == 'very_high' ? 'selected' : '' }}>Very High</option>
                            <option value="high" {{ config.music_quality|default('very_high') == 'high' ? 'selected' : '' }}>High</option>
                            <option value="medium" {{ config.music_quality|default('very_high') == 'medium' ? 'selected' : '' }}>Medium</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_creds">JSON Credentials Path</label>
                    <input type="text" id="music_creds" name="music_creds" value="{{ config.music_creds|default('') }}">
                    <small style="color: var(--text-secondary);">Path to your music provider credentials file.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_archive">History Archive File</label>
                    <input type="text" id="music_archive" name="music_archive" value="{{ config.music_archive|default('') }}">
                    <small style="color: var(--text-secondary);">Path to log previously downloaded songs.</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="music_skip_existing" value="1" {{ config.music_skip_existing|default(false) ? 'checked' : '' }}> Skip Existing
                    </div>
                    <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="music_lyrics" value="1" {{ config.music_lyrics|default(true) ? 'checked' : '' }}> Fetch Lyrics
                    </div>
                    <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="music_print_downloads" value="1" {{ config.music_print_downloads|default(true) ? 'checked' : '' }}> Print Confirmations
                    </div>
                    <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="music_progress" value="1" {{ config.music_progress|default(false) ? 'checked' : '' }}> Stdout Progress
                    </div>
                </div>

                <h3 style="color: var(--accent); margin: 2rem 0 1rem 0;">Lyrics Sources üé§</h3>
                <div style="margin-bottom: 1rem;">
                    <label for="genius_api_token">Genius API Token</label>
                    <input type="text" id="genius_api_token" name="genius_api_token" value="{{ config.genius_api_token|default('') }}" placeholder="Enter Genius Client Access Token">
                    <small style="color: var(--text-secondary);">Used for fetching unsynchronized lyrics.</small>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="lrclib_token">LRCLib Token (Optional)</label>
                    <input type="text" id="lrclib_token" name="lrclib_token" value="{{ config.lrclib_token|default('') }}" placeholder="Enter LRCLib Token">
                    <small style="color: var(--text-secondary);">LRCLib usually doesn't require a token for standard usage.</small>
                </div>

                <div style="margin-top: 1rem;">
                    <label for="music_retries">Retry Attempts</label>
                    <input type="number" id="music_retries" name="music_retries" value="{{ config.music_retries|default(3) }}" min="0" max="10">
                </div>

                <h3 style="color: var(--accent); margin: 2rem 0 1rem 0;">Library & Tagging üéµüöö</h3>
                
                <div style="margin-bottom: 1rem;">
                    <label for="music_library_path">Library Target Path</label>
                    <input type="text" id="music_library_path" name="music_library_path" value="{{ config.music_library_path|default('') }}" placeholder="/music/library">
                    <small style="color: var(--text-secondary);">Where files are moved after processing.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_genre_tagging_mode">Tagging Mode</label>
                    <select id="music_genre_tagging_mode" name="music_genre_tagging_mode" style="width:100%; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white;">
                        <option value="ai" {{ config.music_genre_tagging_mode|default('ai') == 'ai' ? 'selected' : '' }}>AI (Grok)</option>
                        <option value="mapping" {{ config.music_genre_tagging_mode|default('ai') == 'mapping' ? 'selected' : '' }}>Regex Mapping</option>
                    </select>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_genre_grok_model">Grok Music Model</label>
                    <input type="text" id="music_genre_grok_model" name="music_genre_grok_model" value="{{ config.music_genre_grok_model|default('grok-4-fast-non-reasoning') }}" placeholder="grok-...">
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_genre_grok_prompt">AI Tagging Prompt</label>
                    <textarea id="music_genre_grok_prompt" name="music_genre_grok_prompt" style="width:100%; height:150px; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white; font-family:monospace; font-size:0.8rem;">{{ config.music_genre_grok_prompt|default('') }}</textarea>
                    <small style="color: var(--text-secondary);">System prompt for Grok classification.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_genre_mapping">Regex Genre Mapping (JSON)</label>
                    <textarea id="music_genre_mapping" name="music_genre_mapping" style="width:100%; height:150px; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white; font-family:monospace; font-size:0.8rem;">{{ config.music_genre_mapping|default('') }}</textarea>
                    <small style="color: var(--text-secondary);">JSON object mapping regex patterns to genres.</small>
                </div>
            </section>
        </div>

        <button type="submit" class="btn btn-primary btn-full" style="margin-top: 2rem;">Save All Settings</button>
    </form>
</div>
{% endblock %}
