{% extends 'base.html.twig' %}

{% block title %}Settings - AllDebridDL{% endblock %}

{% block body %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h2>Configuration</h2>
    <form method="post">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Global Settings -->
            <section>
                <h3 style="color: var(--accent); margin-bottom: 1rem;">Global Settings</h3>
                <div style="margin-bottom: 1rem;">
                    <label for="api_key">Alldebrid API Key</label>
                    <input type="text" id="api_key" name="api_key" value="{{ config.api_key|default('') }}" placeholder="Enter your API Key">
                    <small style="color: var(--text-secondary);">Your personal Alldebrid API token.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="grok_api_key">Grok AI API Key (xAI)</label>
                    <input type="text" id="grok_api_key" name="grok_api_key" value="{{ config.grok_api_key|default('') }}" placeholder="xai-...">
                    <small style="color: var(--text-secondary);">Used for AI-assisted file renaming.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="grok_model">Grok Model</label>
                    <input type="text" id="grok_model" name="grok_model" value="{{ config.grok_model|default('grok-4-fast-non-reasoning') }}" placeholder="grok-...">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label for="default_path">Default Torrent Download Path</label>
                    <input type="text" id="default_path" name="default_path" value="{{ config.default_path|default('') }}" placeholder="/nas/downloads/">
                    <small style="color: var(--text-secondary);">Where torrent files are saved by default (can be overidden when downloading a file).</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="history_retention_limit">History Retention Limit</label>
                    <input type="number" id="history_retention_limit" name="history_retention_limit" value="{{ config.history_retention_limit|default(500) }}" min="10" max="1000" required>
                    <small style="color: var(--text-secondary);">Maximum number of history entries to keep (default: 500).</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="grok_renaming_prompt">AI Renaming Prompt</label>
                    <textarea id="grok_renaming_prompt" name="grok_renaming_prompt" style="width:100%; height:200px; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white; font-family:monospace; font-size:0.8rem;">{{ config.grok_renaming_prompt|default(
"1. Use the CONTEXT to identify the Category (Movie, Series, Music, Ebook), Title, and metadata (Season, Year, Artist, Album).
2. Standardize filenames based on category:
   - Series: \"Showname.SxxExx.OptionalTitle.ext\".
   - Anime: \"Showname.SxxExx.OptionalTitle.ext\".
   - Movies: \"Movie Name (Year).ext\".
   - Music: \"XX - Song Name.ext\" (XX = track number, identify from filename).
   - Ebooks: \"Clean Book Title.ext\".
3. Identify episode/track numbers from individual filenames (e.g., \"01.mkv\" is Episode 1).
4. Rules for \"path\":
   - Series: \"Video/TV Shows/Series Name/Season XX/\" (e.g. \"Video/TV Shows/The Sopranos/Season 02/\").
   - Anime: \"Video/Anime/Series Name/Season XX/\" (e.g. \"Video/Anime/Naruto/Season 01/\").
   - Movies: \"Video/Movies/Movie Name (Year)/\" (e.g. \"Video/Movies/Inception (2010)/\").
   - Music: \"Music/Artist Name/Album Name/\" (e.g. \"Music/Pink Floyd/The Wall/\").
   - Ebooks: \"Ebooks/Series Name/\" or \"Ebooks/Author Name/\" (e.g. \"Ebooks/Harry Potter/\"). use a T in front of the volume number when required. Only keep the name of the book (and the series if there is one) in the filename.
5. Return a JSON object where keys are ORIGINAL filenames and values are another JSON object containing \"filename\" and \"path\".
6. For ebooks NEVER change the language of the book title.
7. Maintain the exact original file extension.") }}</textarea>
                    <small style="color: var(--text-secondary);">System instructions for Grok regarding file renaming and path generation.</small>
                </div>

                <h3 style="color: var(--accent); margin: 2rem 0 1rem 0;">Spotify API (Metadata)</h3>
                <div style="margin-bottom: 1rem;">
                    <label for="spotify_client_id">Spotify Client ID</label>
                    <input type="text" id="spotify_client_id" name="spotify_client_id" value="{{ config.spotify_client_id|default('') }}" placeholder="Enter Client ID">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="spotify_client_secret">Spotify Client Secret</label>
                    <input type="password" id="spotify_client_secret" name="spotify_client_secret" value="{{ config.spotify_client_secret|default('') }}" placeholder="Enter Client Secret">
                    <small style="color: var(--text-secondary);">Required for real-time track metadata extraction.</small>
                </div>

                <h3 style="color: var(--accent); margin: 2rem 0 1rem 0;">App Security üîê</h3>
                <div style="margin-bottom: 1rem;">
                    <label for="admin_user">Username</label>
                    <input type="text" id="admin_user" name="admin_user" value="{{ config.admin_user|default('admin') }}" required>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="admin_password">Password</label>
                    <input type="password" id="admin_password" name="admin_password" value="{{ config.admin_password|default('admin') }}" required>
                    <small style="color: var(--text-secondary);">Used to secure your dashboard.</small>
                </div>
            </section>

            <!-- Music Settings -->
            <section>
                <h3 style="color: var(--accent); margin-bottom: 1rem;">Music Downloader</h3>
                
                <div style="margin-bottom: 1rem;">
                    <label for="music_venv_path">Venv Path (Relative)</label>
                    <input type="text" id="music_venv_path" name="music_venv_path" value="{{ config.music_venv_path|default('/opt/venv') }}">
                    <small style="color: var(--text-secondary);">Path to python virtual environment folder.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_binary">Music Command Binary</label>
                    <input type="text" id="music_binary" name="music_binary" value="{{ config.music_binary|default('zotify') }}">
                    <small style="color: var(--text-secondary);">The command to run (e.g., spotdl, zotify).</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_librespot_auth_binary">Librespot Auth Binary</label>
                    <input type="text" id="music_librespot_auth_binary" name="music_librespot_auth_binary" value="{{ config.music_librespot_auth_binary|default('/var/www/html/var/librespot-auth/target/release/librespot-auth') }}">
                    <small style="color: var(--text-secondary);">Path to the librespot-auth binary (used for generating credentials).</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_root_path">Music Download Root</label>
                    <input type="text" id="music_root_path" name="music_root_path" value="{{ config.music_root_path|default('') }}">
                    <small style="color: var(--text-secondary);">Base directory for music files.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_output">Output Template</label>
                    <input type="text" id="music_output" name="music_output" value="{{ config.music_output|default('{artist} - {album} - {song_name}.{ext}') }}">
                    <small style="color: var(--text-secondary);">Filename format. Use tags like {artist}, {song_name}.</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label for="music_format">Format</label>
                        <select id="music_format" name="music_format" style="width:100%; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white;">
                            <option value="mp3" {{ config.music_format|default('mp3') == 'mp3' ? 'selected' : '' }}>MP3</option>
                            <option value="flac" {{ config.music_format|default('mp3') == 'flac' ? 'selected' : '' }}>FLAC</option>
                            <option value="m4a" {{ config.music_format|default('mp3') == 'm4a' ? 'selected' : '' }}>M4A</option>
                            <option value="opus" {{ config.music_format|default('mp3') == 'opus' ? 'selected' : '' }}>OPUS</option>
                        </select>
                    </div>
                    <div>
                        <label for="music_quality">Quality</label>
                        <select id="music_quality" name="music_quality" style="width:100%; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white;">
                            <option value="very_high" {{ config.music_quality|default('very_high') == 'very_high' ? 'selected' : '' }}>Very High</option>
                            <option value="high" {{ config.music_quality|default('very_high') == 'high' ? 'selected' : '' }}>High</option>
                            <option value="medium" {{ config.music_quality|default('very_high') == 'medium' ? 'selected' : '' }}>Medium</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_creds">JSON Credentials Path</label>
                    <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                        <div style="flex-grow: 1;">
                            <input type="text" id="music_creds" name="music_creds" value="{{ config.music_creds|default('/var/www/html/var/home/.local/credentials.json') }}">
                        </div>
                        <button type="button" id="btn-generate-auth" class="btn btn-secondary" style="white-space: nowrap; padding: 0.75rem 1rem; {{ creds_exists ? 'display: none;' : '' }}">
                           <span id="auth-btn-text">‚ö° Auth</span>
                           <span id="auth-btn-spinner" style="display: none;">‚è≥...</span>
                        </button>
                    </div>
                    <small style="color: var(--text-secondary);">Path to your music provider credentials file.</small>
                    <div id="auth-status" style="margin-top: 0.5rem; font-size: 0.85rem; display: none;"></div>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_archive">History Archive File</label>
                    <input type="text" id="music_archive" name="music_archive" value="{{ config.music_archive|default('/var/www/html/var/home/log/archive.txt') }}">
                    <small style="color: var(--text-secondary);">Path to log previously downloaded songs.</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="music_skip_existing" value="1" {{ config.music_skip_existing|default(false) ? 'checked' : '' }}> Skip Existing
                    </div>
                    <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="music_lyrics" value="1" {{ config.music_lyrics|default(true) ? 'checked' : '' }}> Fetch Lyrics
                    </div>
                    <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="music_print_downloads" value="1" {{ config.music_print_downloads|default(true) ? 'checked' : '' }}> Print Confirmations
                    </div>
                    <div style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="music_progress" value="1" {{ config.music_progress|default(false) ? 'checked' : '' }}> Stdout Progress
                    </div>
                </div>

                <h3 style="color: var(--accent); margin: 2rem 0 1rem 0;">Lyrics Sources üé§</h3>
                <div style="margin-bottom: 1rem;">
                    <label for="genius_api_token">Genius API Token</label>
                    <input type="text" id="genius_api_token" name="genius_api_token" value="{{ config.genius_api_token|default('') }}" placeholder="Enter Genius Client Access Token">
                    <small style="color: var(--text-secondary);">Used for fetching unsynchronized lyrics.</small>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="lrclib_token">LRCLib Token (Optional)</label>
                    <input type="text" id="lrclib_token" name="lrclib_token" value="{{ config.lrclib_token|default('') }}" placeholder="Enter LRCLib Token">
                    <small style="color: var(--text-secondary);">LRCLib usually doesn't require a token for standard usage.</small>
                </div>

                <div style="margin-top: 1rem;">
                    <label for="music_retries">Retry Attempts</label>
                    <input type="number" id="music_retries" name="music_retries" value="{{ config.music_retries|default(3) }}" min="0" max="10">
                </div>

                <h3 style="color: var(--accent); margin: 2rem 0 1rem 0;">Library & Tagging üéµüöö</h3>
                
                <div style="margin-bottom: 1rem;">
                    <label for="music_library_path">Library Target Path</label>
                    <input type="text" id="music_library_path" name="music_library_path" value="{{ config.music_library_path|default('') }}" placeholder="/music/library">
                    <small style="color: var(--text-secondary);">Where files are moved after processing.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_genre_tagging_mode">Tagging Mode</label>
                    <select id="music_genre_tagging_mode" name="music_genre_tagging_mode" style="width:100%; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white;">
                        <option value="ai" {{ config.music_genre_tagging_mode|default('ai') == 'ai' ? 'selected' : '' }}>AI (Grok)</option>
                        <option value="mapping" {{ config.music_genre_tagging_mode|default('ai') == 'mapping' ? 'selected' : '' }}>Regex Mapping</option>
                    </select>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_genre_grok_model">Grok Music Model</label>
                    <input type="text" id="music_genre_grok_model" name="music_genre_grok_model" value="{{ config.music_genre_grok_model|default('grok-4-fast-non-reasoning') }}" placeholder="grok-...">
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_genre_grok_prompt">AI Tagging Prompt</label>
                    <textarea id="music_genre_grok_prompt" name="music_genre_grok_prompt" style="width:100%; height:150px; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white; font-family:monospace; font-size:0.8rem;">{{ config.music_genre_grok_prompt|default("Tu es un expert en classification musicale. Ton objectif est de d√©terminer le genre musical d'une chanson √† partir de son artiste et de son titre, en respectant strictement une cat√©gorisation sp√©cifique. 
            Les genres peuvent √™tre cumulables : si un morceau appartient √† plusieurs cat√©gories, s√©pare les genres par le caract√®re ' / '. 
            Rap & Hip-Hop n'est cumulable qu'avec Latin sinon il est dominant
            
            Voici les r√®gles pr√©cises que tu dois suivre :
            - \"Rap & Hip-Hop\" : Pour tous les morceaux de rap et hip-hop avec des paroles dans une langue autre que le fran√ßais.
            - \"Rap Fran√ßais\" : Pour tous les morceaux de rap avec des paroles en fran√ßais.
            - \"Electro\" : Pour tous les morceaux de musique √©lectronique (techno, trance, EDM, etc.), sauf la house.
            - \"House\" : Pour tous les types de house (deep house, progressive house, tech house, etc.).
            - \"Reggaeton\" : Pour tous les morceaux de reggaeton.
            - \"Vari√©t√© Am√©ricaine\" : Pour tous les morceaux de chanson (hors rap, hip-hop, electro, house, reggaeton, pop, rock) d'artistes am√©ricains ou avec des paroles en anglais am√©ricain.
            - \"Vari√©t√© Internationale\" : Pour tous les morceaux de chanson (hors rap, hip-hop, electro, house, reggaeton, pop, rock) dans une langue autre que le fran√ßais ou l'anglais am√©ricain.
            - \"Vari√©t√© Fran√ßaise\" : Pour tous les morceaux de chanson (hors rap, hip-hop, electro, house, reggaeton, pop, rock) avec des paroles en fran√ßais.
            - \"Pop\" : Pour tous les morceaux de pop, quelle que soit la langue.
            - \"Rock\" : Pour tous les morceaux de rock ou apparent√©s (rock alternatif, punk, metal, grunge, etc.).
            - \"Latin\" : Pour tous les morceaux de musique latine (salsa, bachata, cumbia, etc.), hors reggaeton.
            - \"Instrumental / Trip-Hop\" : Pour tous les morceaux sans paroles d'abstract hip-hop, trip-hop ou instrumentaux dans ce style.
            - \"Ambiance\" : Pour tous les morceaux d'ambiance (chill, downtempo, lounge, etc.).
            - \"Classical\" : Pour tous les morceaux orchestraux ou de musique classique.
            - \"Funk\" : Pour tous les morceaux de funk ou genres apparent√©s
            - \"Jazz\" : Pour tous les morceaux de jazz ou genres apparent√©s
            - \"Soul\" : Pour tous les morceaux de soul ou genres apparent√©s

            Instructions :
            - Si tu as un doute sur la langue ou le style, base-toi sur les informations typiquement associ√©es √† l'artiste ou √† l'album.
            - R√©ponds UNIQUEMENT par le nom du ou des genres, sans aucun autre texte, commentaire ou explication (exemple : \"Pop / Rock\").") }}</textarea>
                    <small style="color: var(--text-secondary);">System prompt for Grok classification.</small>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="music_genre_mapping">Regex Genre Mapping (JSON)</label>
                    <textarea id="music_genre_mapping" name="music_genre_mapping" style="width:100%; height:150px; padding:0.75rem; background:var(--bg-primary); border:1px solid rgba(255,255,255,0.1); border-radius:0.5rem; color:white; font-family:monospace; font-size:0.8rem;">{{ config.music_genre_mapping|default('{
    "genre_patterns": {
        "(?i)^(?!(.*french|.*fran\\u00e7ais|.*rap.*hip.*hop|.*instrumental)).*\\\\s*rap\\\\s*": "Rap & Hip-Hop",
        "(?i)^(?!(.*rap.*hip.*hop|.*instrumental)).*\\\\s*hip[- ]?hop\\\\s*": "Rap & Hip-Hop",
        "(?i)g[ -]?funk": "Rap & Hip-Hop",
        "(?i)dembow|afropop|afroswing|grime|horrorcore|phonk|uk drill|comedy": "Rap & Hip-Hop",
        "(?i)downtempo|psytrance|^edm$": "Electro",
        "(?i)trip[- ]?hop|^idm$|chillstep": "Instrumental / Trip-Hop",
        "(?i)retro soul": "Soul",
        "(?i)pop urbaine": "Rap Fr\\u00e7ais",
        "(?i)french pop|chanson": "Vari\\u00e9t\\u00e9 Fran\\u00e7aise",
        "(?i)soft pop|europop|psychedelic pop|hyperpop|folk pop|alternative dance|art pop|baroque pop|bedroom pop|britpop": "Pop",
        "(?i)post-grunge|nu metal|glam metal|grunge": "Rock",
        "(?i)nueva trova|fado": "Latin",
        "(?i)amapiano": "Afrobeats",
        "(?i)^ebm$": "Techno",
        "(?i)\\\\s*rock\\\\s*": "Rock",
        "(?i)\\\\s*punk\\\\s*": "Rock",
        "(?i)\\\\s*house\\\\s*": "House",
        "(?i)\\\\s*lo-fi\\\\s*": "Instrumental / Trip-Hop",
        "(?i)\\\\s*techno\\\\s*": "Techno",
        "(?i)\\\\s*jazz\\\\s*": "Jazz",
        "(?i)\\\\s*latin\\\\s*": "Latin",
        "(?i)\\\\s*electro\\\\s*": "Electro",
        "(?i)\\\\s*r&b\\\\s*": "R&B"
    }
}') }}</textarea>
                    <small style="color: var(--text-secondary);">JSON object mapping regex patterns to genres.</small>
                </div>
            </section>

            <!-- Maintenance & Database -->
            <section style="grid-column: span 2; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <h3 style="color: var(--accent); margin-bottom: 1rem;">Maintenance & Database</h3>
                <div style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 2rem;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0;">Update Torrent Database</h4>
                            <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">
                                Triggers a <code>composer update gautardos/hash-db</code> to fetch the latest torrent hashes from the repository. 
                                This operation might take several minutes depending on your connection.
                            </p>
                        </div>
                        <button type="button" id="btn-update-hash-db" class="btn btn-secondary" style="min-width: 200px; background: #17a2b8;">
                            <span id="update-db-text">üîÑ Update Database</span>
                            <span id="update-db-spinner" style="display: none;">‚è≥ Updating...</span>
                        </button>
                    </div>
                    <div id="update-db-status" style="margin-top: 1rem; padding: 1rem; border-radius: 6px; display: none; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </section>
        </div>

        <button type="submit" class="btn btn-primary btn-full" style="margin-top: 2rem;">Save All Settings</button>
    </form>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.getElementById('btn-generate-auth').addEventListener('click', async function() {
    const btn = this;
    const btnText = document.getElementById('auth-btn-text');
    const btnSpinner = document.getElementById('auth-btn-spinner');
    const statusDiv = document.getElementById('auth-status');

    if (!confirm('This will execute the librespot-auth command. You might need to check the logs or external browser to complete authentication. Continue?')) {
        return;
    }

    btn.disabled = true;
    btnText.style.display = 'none';
    btnSpinner.style.display = 'inline';
    statusDiv.style.display = 'block';
    statusDiv.style.color = 'var(--accent)';
    
    // Generate a temporary device name to show while loading (matches PHP logic)
    const tempName = "Speaker xxx";
    statusDiv.innerHTML = `
        <div style="background: rgba(23, 162, 184, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #17a2b8; margin-bottom: 1rem;">
            <p style="margin: 0 0 0.5rem 0; font-weight: bold; color: #17a2b8;">üéß Action Required: Spotify Connect Login</p>
            <p style="margin: 0; font-size: 0.9rem;">
                Please open your Spotify app on your phone or computer (on the same network).<br>
                Select the device named <strong>"${tempName}"</strong> from the available devices list to complete the authentication.
            </p>
        </div>
        <p style="text-align: center; color: var(--text-secondary); font-size: 0.8rem;">‚åõ Waiting for connection from Spotify...</p>
    `;

    try {
        const response = await fetch("{{ path('config_spotify_auth') }}", {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            statusDiv.style.color = 'var(--success)';
            statusDiv.innerText = '‚úÖ ' + result.message;
            // Hide the button since file now exists
            btn.style.display = 'none';
            // Update the path field
            const credsInput = document.getElementById('music_creds');
            if (credsInput) {
                credsInput.value = result.path;
            }
        } else {
            statusDiv.style.color = 'var(--danger)';
            let errHtml = '‚ùå ' + result.message;
            
            if (result.debug) {
                errHtml += '<div style="margin-top:0.5rem; font-family:monospace; font-size:0.75rem; background:rgba(0,0,0,0.3); padding:0.5rem; border-radius:4px; border:1px solid var(--accent);">';
                errHtml += '<strong>Environment:</strong><br>';
                errHtml += 'User: ' + result.debug.user + '<br>';
                errHtml += 'PHP CWD: ' + (result.debug.php_cwd || 'unknown') + '<br>';
                errHtml += 'Home Writable: ' + result.debug.home_writable + '<br>';
                errHtml += 'Binary Executable: ' + result.debug.binary_executable + '<br>';
                errHtml += 'Binary Path: ' + result.debug.binary_path + '<br>';
                errHtml += 'Expected File: ' + result.debug.expected_file + '</div>';
            }

            if (result.command) {
                errHtml += '<div style="margin-top:0.5rem; font-family:monospace; font-size:0.75rem; background:rgba(0,0,0,0.3); padding:0.5rem; border-radius:4px; border:1px solid var(--danger);">';
                errHtml += '<strong>Command:</strong><br>' + result.command + '<br><br>';
                errHtml += '<strong>Output:</strong><br>' + (result.output || '(no output)') + '</div>';
            }
            statusDiv.innerHTML = errHtml;
        }
    } catch (e) {
        statusDiv.style.color = 'var(--danger)';
        statusDiv.innerText = '‚ùå Error: ' + e.message;
    } finally {
        btn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
    }
});

document.getElementById('btn-update-hash-db').addEventListener('click', async function() {
    const btn = this;
    const btnText = document.getElementById('update-db-text');
    const btnSpinner = document.getElementById('update-db-spinner');
    const statusDiv = document.getElementById('update-db-status');

    if (!confirm('This will trigger a composer update for the torrent database. It might take a while and could potentially slow down the app. Continue?')) {
        return;
    }

    btn.disabled = true;
    btnText.style.display = 'none';
    btnSpinner.style.display = 'inline';
    statusDiv.style.display = 'block';
    statusDiv.style.background = 'rgba(255,255,255,0.05)';
    statusDiv.style.color = 'var(--text-secondary)';
    statusDiv.innerText = 'Starting update... please wait.';

    try {
        const response = await fetch("{{ path('config_update_hash_db') }}", {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            statusDiv.style.background = 'rgba(40, 167, 69, 0.1)';
            statusDiv.style.color = 'var(--success)';
            statusDiv.style.border = '1px solid var(--success)';
            statusDiv.innerText = '‚úÖ ' + result.message + '\n\n' + (result.output || '');
        } else {
            statusDiv.style.background = 'rgba(220, 53, 69, 0.1)';
            statusDiv.style.color = 'var(--danger)';
            statusDiv.style.border = '1px solid var(--danger)';
            statusDiv.innerText = '‚ùå ' + result.message + '\n\n' + (result.details || '');
        }
    } catch (e) {
        statusDiv.style.background = 'rgba(220, 53, 69, 0.1)';
        statusDiv.style.color = 'var(--danger)';
        statusDiv.style.border = '1px solid var(--danger)';
        statusDiv.innerText = '‚ùå Error: ' + e.message;
    } finally {
        btn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
    }
});
</script>
{% endblock %}
