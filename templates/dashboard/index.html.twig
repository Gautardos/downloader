{% extends 'base.html.twig' %}

{% block title %}Torrent Downloader{% endblock %}

{% block body %}
<div class="container">
    <h1>üì• Downloads</h1>

    {% if packs is empty %}
        <p style="text-align: center; color: var(--text-secondary); margin: 3rem 0;">
            No recent downloads found. Configure your API key to get started.
        </p>
    {% else %}
        <!-- Recent Paths Datalist -->
        <datalist id="recent-paths-list">
            {% for path in recent_paths %}
                <option value="{{ path }}">
            {% endfor %}
        </datalist>

        <div style="display: flex; justify-content: flex-end; margin-bottom: 2rem;">
            <button class="btn btn-primary" onclick="openUploadModal()" style="display: flex; align-items: center; gap: 0.5rem;">
                <span>‚òÅÔ∏è</span> Upload Torrent / Magnet
            </button>
        </div>


        <div class="packs-grid">
            {% for pack in packs %}
                <div class="pack-card">
                    <div class="pack-loader-overlay">
                        <div class="spinner"></div>
                        <span style="color: white; font-size: 0.9rem;">AI Renaming in progress...</span>
                    </div>
                    <div class="pack-header" onclick="togglePack('pack-{{ loop.index }}')">
                        <div class="pack-info">
                            <h2>
                                <span class="pack-icon">üìÅ</span>
                                {{ pack.name }}
                            </h2>
                            <div class="pack-meta">
                                <span>{{ pack.file_count }} file{{ pack.file_count > 1 ? 's' : '' }}</span>
                                <span>‚Ä¢</span>
                                <span>{{ (pack.total_size / 1024 / 1024 / 1024)|number_format(2) }} GB</span>
                                <span>‚Ä¢</span>
                                <span style="color: {{ pack.progress == 100 ? 'var(--success)' : 'var(--accent)' }}">{{ pack.progress }}%</span>
                            </div>
                            <div class="pack-progress-container" style="margin-top: 0.5rem; background: rgba(255,255,255,0.05); height: 4px; border-radius: 2px; overflow: hidden; width: 200px;">
                                <div class="pack-progress-bar" style="width: {{ pack.progress }}%; height: 100%; background: {{ pack.progress == 100 ? 'var(--success)' : 'var(--accent)' }}; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        <div class="pack-actions" onclick="event.stopPropagation()">
                            {% if pack.file_count > 1 %}
                                <div class="pack-actions-buttons">
                                    <div style="display: flex; gap: 0.5rem; width: 100%;">
                                        <button class="btn btn-secondary btn-icon" onclick="suggestNames('pack-{{ loop.index }}', '{{ pack.name|e('js') }}', {{ pack.files|json_encode|e('html_attr') }})" title="AI Rename All">
                                            ‚ú®
                                        </button>
                                        <input type="text" class="pack-path-input" 
                                               placeholder="Common folder (optional)" 
                                               list="recent-paths-list"
                                               style="flex: 1;">
                                    </div>
                                    <button class="btn btn-secondary btn-download-pack btn-full" onclick="downloadPack(event, 'pack-{{ loop.index }}', {{ pack.files|json_encode|e('html_attr') }})">
                                        Download All
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div id="pack-{{ loop.index }}" class="pack-files {{ pack.file_count == 1 ? '' : 'collapsed' }}">
                        {% for file in pack.files %}
                            <div class="file-card" id="file-{{ pack.name|replace({'.': '_', ' ': '_', '/': '_'}) }}-{{ loop.index }}">
                                <div class="file-info">
                                    <div class="file-name">
                                        {% if file.subpath %}
                                            <span style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-bottom: 2px;">
                                                üìÅ {{ file.subpath }}
                                            </span>
                                        {% endif %}
                                        {{ file.filename }}
                                        {% if file.downloaded %}
                                            <span class="badge badge-success">Downloaded</span>
                                        {% endif %}
                                    </div>
                                    <div class="file-size">
                                        {{ (file.size / 1024 / 1024)|number_format(2) }} MB
                                    </div>
                                </div>

                                <div class="progress-container" style="display: none;">
                                    <div style="background-color: var(--bg-primary); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem;">
                                        <div class="progress-bar" style="background-color: var(--accent); height: 100%; width: 0%; transition: width 0.5s;"></div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary);">
                                        <span class="progress-status">Starting...</span>
                                        <span class="progress-speed">0 MB/s</span>
                                    </div>
                                </div>

                                 <form class="download-form" onsubmit="startDownload(event, 'pack-{{ loop.parent.loop.index }}', {{ file|json_encode|e('html_attr') }})">
                                     <input type="hidden" name="url" value="{{ file.link }}">
                                     <input type="hidden" name="filename" value="{{ file.filename }}">
                                     
                                     <div class="form-row">
                                         <input type="text" name="path" placeholder="Override path" 
                                                list="recent-paths-list" class="input-path">
                                         <div class="rename-group">
                                             <input type="text" name="override_filename" placeholder="Rename to..." class="input-rename">
                                             <button type="button" class="btn btn-secondary btn-icon" onclick="suggestNames('pack-{{ loop.parent.loop.index }}', '{{ pack.name|e('js') }}', [{filename: '{{ file.filename|e('js') }}'}], this)" title="AI Rename">
                                                 ‚ú®
                                             </button>
                                         </div>
                                     </div>
                                     
                                     <button type="submit" class="btn btn-primary download-btn" style="width: 100%;">
                                         {% if file.downloaded %}Re-Download{% else %}Download{% endif %}
                                     </button>
                                 </form>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Recent Paths Manager -->
        <div class="recent-paths-manager">
            <h3>Recent Folders</h3>
            <div class="recent-paths-list">
                {% if recent_paths is empty %}
                    <p class="empty-msg">No folders saved yet.</p>
                {% else %}
                    {% for path in recent_paths %}
                        <div class="recent-path-item">
                            <span class="path-text" title="{{ path }}">{{ path }}</span>
                            <button class="btn-remove-path" onclick="deleteRecentPath('{{ path|e('js') }}')">√ó</button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    {% endif %}


    <!-- Upload Torrent Modal -->
    <div id="upload-modal" class="modal-overlay">
        <div class="modal-container" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚òÅÔ∏è Upload Torrent / Magnet</h2>
                <button class="btn-close-modal" onclick="closeUploadModal()">√ó</button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <!-- Drag and Drop Zone -->
                <div id="drop-zone" style="border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 3rem 2rem; text-align: center; transition: all 0.2s; cursor: pointer; margin-bottom: 2rem;"
                     onclick="document.getElementById('torrent-file-input').click()"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                    <h3 style="margin: 0 0 0.5rem 0;">Click or Drop .torrent file here</h3>
                    <p style="color: var(--text-secondary); margin: 0;">Supports single .torrent file upload</p>
                    <input type="file" id="torrent-file-input" accept=".torrent" style="display: none" onchange="handleFileSelect(this)">
                </div>

                <div style="text-align: center; margin-bottom: 2rem; position: relative;">
                    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1);">
                    <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--bg-secondary); padding: 0 1rem; color: var(--text-secondary); font-size: 0.9rem;">OR</span>
                </div>

                <!-- Torrent Database Search -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">üîé Search Torrent Database</label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <select id="torrent-db-category" style="padding: 0.5rem; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white; min-width: 150px;">
                            <option value="">Select type...</option>
                        </select>
                        <input type="text" id="torrent-db-query" placeholder="Search title..." 
                               style="margin:0; flex: 1; padding: 0.5rem; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;"
                               oninput="debouncedTorrentSearch()">
                    </div>
                    <div id="torrent-db-results" style="max-height: 200px; overflow-y: auto; display: none;">
                        <!-- Results will be populated here -->
                    </div>
                    <div id="torrent-db-loading" style="display: none; text-align: center; padding: 0.5rem; color: var(--text-secondary);">
                        ‚è≥ Searching...
                    </div>
                </div>

                <!-- Magnet Link Input -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Magnet Link</label>
                    <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                        <textarea id="magnet-input" placeholder="magnet:?xt=urn:btih:..." rows="3"
                                  style="flex: 1; padding: 1rem; background: var(--bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; resize: vertical;"></textarea>
                        <button class="btn btn-secondary" id="btn-magnet-preview" onclick="previewMagnet()" style="white-space: nowrap; background: #17a2b8; height: fit-content;">
                            üîç Preview
                        </button>
                    </div>
                </div>
                
                <!-- Magnet Info Preview Area -->
                <div id="magnet-preview-area" style="word-break: break-all;display: none; margin-bottom: 1rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    <div id="magnet-preview-loading" style="display: none; text-align: center; color: var(--text-secondary);">
                        ‚è≥ Fetching magnet info from Alldebrid...
                    </div>
                    <div id="magnet-preview-result"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="btn-upload" onclick="submitUpload()">Upload</button>
            </div>
        </div>
    </div>

    <!-- Batch Confirmation Modal -->
    <div id="batch-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>üìä Batch Download Confirmation</h2>
                <button class="btn-close-modal" onclick="closeBatchModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="modal-loading-msg" class="empty-msg" style="display: none;">Verifying file conflicts...</div>
                <table class="batch-table" id="batch-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-batch" checked onchange="toggleAllBatch(this)"></th>
                            <th>Filename</th>
                            <th>Target Destination</th>
                            <th>Folder</th>
                            <th>Size</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBatchModal()">Cancel</button>
                <button class="btn btn-secondary" id="btn-create-all-folders" onclick="createAllMissingFolders()" style="display: none; background: #f0ad4e; color: #000;">
                    üìÅ Create All Missing Folders
                </button>
                <button class="btn btn-primary" id="btn-confirm-batch" onclick="confirmBatchDownloads()">Add to Queue</button>
            </div>
        </div>
    </div>
</div>

<script>


async function suggestNames(packId, packName, files, btn = null) {
    let packCard = null;
    if (packId) {
        packCard = document.getElementById(packId).closest('.pack-card');
        packCard.classList.add('loading');
    }
    
    if (btn) {
        btn.disabled = true;
        btn.innerText = '‚åõ';
    }
    
    const fileList = files.map(f => f.filename);
    const formData = new FormData();
    formData.append('packName', packName);
    fileList.forEach(f => formData.append('files[]', f));

    try {
        const res = await fetch("{{ path('post_rename_ai') }}", {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        
        if (data.success && data.suggestions) {
            // Expand pack if closed
            if (packId) {
                const content = document.getElementById(packId);
                content.classList.remove('collapsed');
            }

            // Fill fields
            for (const [original, suggestion] of Object.entries(data.suggestions)) {
                if (!suggestion) continue;
                
                const container = packId ? document.getElementById(packId) : document;
                const filenameInputs = container.querySelectorAll('input[name="filename"]');
                
                for (const input of filenameInputs) {
                    if (input.value === original) {
                        const form = input.closest('form');
                        if (form) {
                            form.querySelector('input[name="override_filename"]').value = suggestion;
                        }
                    }
                }
            }
        }
    } catch (e) {
        console.error("AI Rename failed", e);
    } finally {
        if (packCard) packCard.classList.remove('loading');
        if (btn) {
            btn.disabled = false;
            btn.innerText = '‚ú®';
        }
    }
}

async function removeFromQueue(index) {
    try {
        const res = await fetch(`{{ path('queue_remove', {index: 'IDX'}) }}`.replace('IDX', index), { method: 'POST' });
        if (res.ok) syncWithServer();
    } catch (e) {
        console.error("Failed to remove item", e);
    }
}

async function deleteRecentPath(path) {
    if (!confirm('Remove this folder from recent list?')) return;
    
    const formData = new FormData();
    formData.append('path', path);
    
    const res = await fetch("{{ path('delete_path') }}", {
        method: 'POST',
        body: formData
    });
    
    if (res.ok) {
        location.reload();
    }
}

function togglePack(packId) {
    const packFiles = document.getElementById(packId);
    packFiles.classList.toggle('collapsed');
}

let pendingBatchQueue = [];

function formatSize(bytes) {
    if (bytes === null || bytes === undefined) return '0 B';
    const s = ['B', 'KB', 'MB', 'GB', 'TB'];
    const e = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, e)).toFixed(2) + ' ' + s[e];
}

function closeBatchModal() {
    document.getElementById('batch-modal').style.display = 'none';
}

function toggleAllBatch(mainCheckbox) {
    const checkboxes = document.querySelectorAll('.batch-file-checkbox');
    checkboxes.forEach(cb => cb.checked = mainCheckbox.checked);
}

function joinPath(base, sub) {
    if (!sub) return base;
    if (!base) return sub;
    const sep = base.includes('\\') ? '\\' : '/';
    const subNormalized = sub.replace(/[\/\\]/g, sep);
    return base.endsWith(sep) ? base + subNormalized : base + sep + subNormalized;
}

async function downloadPack(event, packId, files) {
    if (event) event.stopPropagation();
    
    // Find the pack card and inputs
    const packContainer = document.getElementById(packId);
    const packCard = packContainer.closest('.pack-card');
    const packPath = packCard.querySelector('.pack-path-input')?.value || '';
    const defaultPath = "{{ config.default_path|default('')|e('js') }}";
    
    // Prepare candidate list for checking
    const candidates = [];
    const isSingle = !Array.isArray(files);
    const fileList = isSingle ? [files] : files;

    fileList.forEach((file, index) => {
        let fileForm;
        if (isSingle) {
            fileForm = packContainer.querySelector(`input[name="filename"][value="${file.filename.replace(/"/g, '\\"')}"]`).closest('form');
        } else {
            fileForm = packContainer.querySelectorAll('.file-card')[index].querySelector('form');
        }

        const individualPath = fileForm.querySelector('input[name="path"]').value;
        const individualRename = fileForm.querySelector('input[name="override_filename"]').value;
        
        const targetBasePath = individualPath || packPath || defaultPath;
        const targetPath = joinPath(targetBasePath, file.subpath);

        candidates.push({
            original: file,
            path: targetPath,
            basePath: targetBasePath,
            filename: individualRename || file.filename
        });
    });

    // Show loading UI
    const modal = document.getElementById('batch-modal');
    const tableBody = document.querySelector('#batch-table tbody');
    const modalLoading = document.getElementById('modal-loading-msg');
    
    tableBody.innerHTML = '';
    modalLoading.style.display = 'block';
    modal.style.display = 'flex';

    try {
        const res = await fetch("{{ path('check_files') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: candidates.map(c => ({ path: c.path, filename: c.filename })) })
        });
        const data = await res.json();
        
        modalLoading.style.display = 'none';
        
        const defaultPath = "{{ config.default_path|default('')|e('js') }}";

        candidates.forEach((c, idx) => {
            const check = data.results[idx];
            const row = document.createElement('tr');
            if (check.exists) row.className = 'conflict-error';

            let statusHtml = '<span style="color: var(--success)">‚úì Ready</span>';
            if (check.exists) {
                const sameSize = check.currentSize === c.original.size;
                statusHtml = `
                    <div class="conflict-warning" title="${check.fullPath}">
                        ‚ö†Ô∏è Existing (${formatSize(check.currentSize)})
                        ${sameSize ? '<span class="badge badge-success">Same size</span>' : '<span class="badge badge-warning">Diff size</span>'}
                    </div>
                `;
            }

            let folderHtml = check.folderExists 
                ? '<span style="color: var(--success)">‚úì Exists</span>' 
                : `<button class="btn btn-secondary btn-icon" style="width: auto; padding: 0 0.5rem; height: 24px; font-size: 0.7rem; background: var(--danger)" onclick="createMissingFolder('${(c.path || defaultPath).replace(/\\/g, '\\\\')}', this, '${packId}')">üìÅ Create</button>`;

            const resolvedPath = c.path || defaultPath || '(No path set)';

            row.innerHTML = `
                <td><input type="checkbox" class="batch-file-checkbox" checked data-index="${idx}"></td>
                <td>
                    <div style="font-weight: 500;">${c.filename}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${c.filename !== c.original.filename ? 'Orig: ' + c.original.filename : ''}</div>
                </td>
                <td style="word-break: break-all; min-width: 250px;" title="${resolvedPath}">
                    ${resolvedPath}
                </td>
                <td>${folderHtml}</td>
                <td><span class="size-tag">${formatSize(c.original.size)}</span></td>
                <td>${statusHtml}</td>
            `;
            tableBody.appendChild(row);

            pendingBatchQueue.push({
                link: c.original.link,
                filename: c.original.filename,
                override_filename: c.filename !== c.original.filename ? c.filename : null,
                path: c.path,
                overwrite: check.exists
            });
        });

        // Show/hide "Create All Missing Folders" button based on missing folders count
        const missingFolderButtons = document.querySelectorAll('#batch-table tbody button');
        const createAllBtn = document.getElementById('btn-create-all-folders');
        if (missingFolderButtons.length > 0) {
            createAllBtn.style.display = 'inline-block';
        } else {
            createAllBtn.style.display = 'none';
        }

    } catch (e) {
        console.error("Conflict check failed", e);
        closeBatchModal();
        window.notify('error', "Conflict check failed. Server might be down.");
    }
}

async function createMissingFolder(path, btn, packId) {
    btn.disabled = true;
    btn.innerText = '‚åõ...';
    
    try {
        const res = await fetch("{{ path('create_folder') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path })
        });
        const data = await res.json();
        
        if (data.success) {
            window.notify('success', `Folder created: ${path}`);
            // Re-run the check to update the entire modal state (folders might be shared)
            // We need the original files list. Let's find it from the pack data.
            // Simplified: juste change status of THIS button for now, or trigger re-downloadPack logic
            btn.parentElement.innerHTML = '<span style="color: var(--success)">‚úì Created</span>';
        } else {
            window.notify('error', `Folder creation failed: ${data.message}`);
            btn.disabled = false;
            btn.innerText = 'üìÅ retry';
        }
    } catch (e) {
        window.notify('error', "Network error while creating folder.");
        btn.disabled = false;
    }
}

async function createAllMissingFolders() {
    const createButtons = document.querySelectorAll('#batch-table tbody button');
    const foldersToCreate = [];

    createButtons.forEach(btn => {
        if (!btn.disabled && btn.innerText.includes('Create')) {
            const pathMatch = btn.getAttribute('onclick')?.match(/createMissingFolder\('([^']+)'/);
            if (pathMatch && pathMatch[1]) {
                foldersToCreate.push({ path: pathMatch[1], btn: btn });
            }
        }
    });

    if (foldersToCreate.length === 0) {
        window.notify('info', 'All folders already exist.');
        return;
    }

    window.notify('info', `Creating ${foldersToCreate.length} folder(s)...`);

    for (const item of foldersToCreate) {
        item.btn.disabled = true;
        item.btn.innerText = '‚åõ...';
        try {
            const res = await fetch("{{ path('create_folder') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: item.path })
            });
            const data = await res.json();
            if (data.success) {
                item.btn.parentElement.innerHTML = '<span style="color: var(--success)">‚úì Created</span>';
            } else {
                item.btn.innerText = '‚ùå Failed';
            }
        } catch (e) {
            item.btn.innerText = '‚ùå Error';
        }
    }

    window.notify('success', `Finished creating folders.`);
}

async function confirmBatchDownloads() {
    const checkboxes = document.querySelectorAll('.batch-file-checkbox');
    const items = [];

    checkboxes.forEach(cb => {
        if (cb.checked) {
            const index = parseInt(cb.dataset.index);
            const item = pendingBatchQueue[index];
            if (item) items.push(item);
        }
    });

    if (items.length === 0) {
        alert("Select at least one file.");
        return;
    }

    closeBatchModal();
    window.notify('info', `Adding ${items.length} files to server queue...`);

    for (const item of items) {
        const formData = new FormData();
        formData.append('url', item.link);
        formData.append('filename', item.filename);
        if (item.override_filename) formData.append('override_filename', item.override_filename);
        formData.append('path', item.path);
        if (item.overwrite) formData.append('overwrite', '1');
        formData.append('download_id', 'dl_' + Math.random().toString(36).substr(2, 9));

        try {
            const res = await fetch("{{ path('download') }}", { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                window.notify('success', `Enqueued: ${item.override_filename || item.filename}`);
            } else {
                window.notify('error', `Failed to enqueue: ${item.filename} - ${data.message}`);
            }
        } catch (e) {
            window.notify('error', `Network error while enqueuing ${item.filename}`);
        }
    }
    
}

function startDownload(event, packId, file) {
    if (event) event.preventDefault();
    downloadPack(null, packId, file);
}


let lastUploadSuccess = false;

async function previewMagnet() {
    const magnetInput = document.getElementById('magnet-input');
    const magnet = magnetInput.value.trim();
    
    if (!magnet) {
        window.notify('warning', 'Please enter a magnet link first.');
        return;
    }
    
    const previewArea = document.getElementById('magnet-preview-area');
    const loadingDiv = document.getElementById('magnet-preview-loading');
    const resultDiv = document.getElementById('magnet-preview-result');
    const btn = document.getElementById('btn-magnet-preview');
    
    previewArea.style.display = 'block';
    loadingDiv.style.display = 'block';
    resultDiv.innerHTML = '';
    btn.disabled = true;
    btn.innerText = '‚è≥...';
    
    try {
        const res = await fetch("{{ path('magnet_info') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ magnet: magnet })
        });
        const data = await res.json();
        
        loadingDiv.style.display = 'none';
        btn.disabled = false;
        btn.innerText = 'üîç Preview';
        
        if (!data.success) {
            resultDiv.innerHTML = `<div style="color: var(--danger);">‚ùå ${data.message}</div>`;
            return;
        }
        
        // Build status badge
        let statusBadge = '<span class="badge badge-warning">Processing</span>';
        if (data.statusCode === 4 || data.status === 'Ready') {
            statusBadge = '<span class="badge badge-success">Ready</span>';
        } else if (data.status === 'pending') {
            statusBadge = '<span class="badge badge-warning">Pending</span>';
        }
        
        // Build file list HTML
        let filesHtml = '';
        if (data.files && data.files.length > 0) {
            filesHtml = '<div style="max-height: 200px; overflow-y: auto; margin-top: 1rem; font-size: 0.85rem;">';
            data.files.forEach(f => {
                const pathStr = f.path ? `<span style="color: var(--text-secondary); font-size: 0.75rem;">üìÅ ${f.path}/</span><br>` : '';
                filesHtml += `
                    <div style="padding: 0.3rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        ${pathStr}
                        <span>${f.filename}</span>
                        <span class="size-tag" style="float: right;">${formatSize(f.size)}</span>
                    </div>
                `;
            });
            filesHtml += '</div>';
        } else {
            filesHtml = '<div style="color: var(--text-secondary); margin-top: 1rem;">No files available yet. Torrent may still be processing.</div>';
        }
        
        resultDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                <div>
                    <strong style="font-size: 1.1rem;">${data.filename || 'Unknown'}</strong>
                    ${statusBadge}
                </div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                    ${data.file_count || 0} file(s) ‚Ä¢ ${formatSize(data.total_size || 0)}
                </div>
            </div>
            ${filesHtml}
        `;
        
    } catch (e) {
        loadingDiv.style.display = 'none';
        btn.disabled = false;
        btn.innerText = 'üîç Preview';
        resultDiv.innerHTML = '<div style="color: var(--danger);">‚ùå Network error. Could not fetch magnet info.</div>';
    }
}

function openUploadModal() {
    lastUploadSuccess = false;
    document.getElementById('upload-modal').style.display = 'flex';
    // Reset preview area
    document.getElementById('magnet-preview-area').style.display = 'none';
    document.getElementById('magnet-preview-result').innerHTML = '';
    // Reset search
    document.getElementById('torrent-db-query').value = '';
    document.getElementById('torrent-db-results').style.display = 'none';
    document.getElementById('torrent-db-results').innerHTML = '';
    // Load categories if not already loaded
    loadTorrentDbCategories();
}

let torrentDbCategoriesLoaded = false;
async function loadTorrentDbCategories() {
    if (torrentDbCategoriesLoaded) return;
    
    try {
        const res = await fetch("{{ path('torrent_db_categories') }}");
        const data = await res.json();
        
        if (data.success && data.categories) {
            const select = document.getElementById('torrent-db-category');
            data.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name.replace(/_/g, ' ');
                select.appendChild(option);
            });
            torrentDbCategoriesLoaded = true;
        }
    } catch (e) {
        console.error('Failed to load torrent DB categories', e);
    }
}

let torrentSearchTimeout = null;
function debouncedTorrentSearch() {
    clearTimeout(torrentSearchTimeout);
    torrentSearchTimeout = setTimeout(searchTorrentDb, 300);
}

async function searchTorrentDb() {
    const categoryId = document.getElementById('torrent-db-category').value;
    const query = document.getElementById('torrent-db-query').value.trim();
    const resultsDiv = document.getElementById('torrent-db-results');
    const loadingDiv = document.getElementById('torrent-db-loading');
    
    if (!categoryId || query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    loadingDiv.style.display = 'block';
    resultsDiv.style.display = 'none';
    
    try {
        const res = await fetch("{{ path('torrent_db_search') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ categoryId: parseInt(categoryId), query: query })
        });
        const data = await res.json();
        
        loadingDiv.style.display = 'none';
        
        if (data.success && data.results && data.results.length > 0) {
            resultsDiv.innerHTML = '';
            data.results.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s;';
                div.innerHTML = `<span style="font-size: 0.9rem;">${item.title}</span>`;
                div.onmouseenter = () => div.style.background = 'rgba(255,255,255,0.1)';
                div.onmouseleave = () => div.style.background = 'transparent';
                div.onclick = () => selectTorrentResult(item.hash, item.title);
                resultsDiv.appendChild(div);
            });
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.innerHTML = '<div style="padding: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">No results found</div>';
            resultsDiv.style.display = 'block';
        }
    } catch (e) {
        loadingDiv.style.display = 'none';
        resultsDiv.innerHTML = '<div style="padding: 0.5rem; color: var(--danger);">Search failed</div>';
        resultsDiv.style.display = 'block';
    }
}

function selectTorrentResult(hash, title) {
    const magnetLink = `magnet:?xt=urn:btih:${hash}`;
    document.getElementById('magnet-input').value = magnetLink;
    document.getElementById('torrent-db-results').style.display = 'none';
    window.notify('success', `Selected: ${title.substring(0, 50)}...`);
}

function closeUploadModal() {
    document.getElementById('upload-modal').style.display = 'none';
    if (lastUploadSuccess) {
        location.reload();
    }
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.style.borderColor = 'var(--accent)';
    e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
}

function handleDragLeave(e) {
    e.preventDefault();
    e.currentTarget.style.borderColor = 'rgba(255,255,255,0.2)';
    e.currentTarget.style.background = 'transparent';
}

function handleDrop(e) {
    e.preventDefault();
    handleDragLeave(e);
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFiles(files);
    }
}

function handleFileSelect(input) {
    if (input.files.length > 0) {
        handleFiles(input.files);
    }
}

let selectedFile = null;

function handleFiles(files) {
    const file = files[0];
    if (file && file.name.endsWith('.torrent')) {
        selectedFile = file;
        const dropZone = document.getElementById('drop-zone');
        dropZone.innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--success);">‚úÖ</div>
            <h3 style="margin: 0 0 0.5rem 0;">${file.name}</h3>
            <p style="color: var(--text-secondary); margin: 0;">Ready to upload</p>
        `;
    } else {
        alert('Please select a valid .torrent file');
    }
}

async function submitUpload() {
    const magnet = document.getElementById('magnet-input').value;
    const btn = document.getElementById('btn-upload');
    const formData = new FormData();

    if (magnet) {
        formData.append('magnet', magnet);
    } else if (selectedFile) {
        formData.append('file', selectedFile);
    } else {
        alert('Please provide a magnet link or select a file.');
        return;
    }

    btn.disabled = true;
    btn.innerText = 'Uploading...';
    let data;

    try {
        const res = await fetch("{{ path('upload_torrent') }}", {
            method: 'POST',
            body: formData
        });
        data = await res.json();
        console.log("Upload Response Data:", data);

        if (data.success) {
            lastUploadSuccess = true;
            window.notify('success', 'Upload successful!');
            
            if (data.links && data.links.length > 0) {
                // Show recap
                const dropZone = document.getElementById('drop-zone');
                let linksHtml = `
                    <div style="text-align: left; margin-top: 1rem; max-height: 300px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: var(--accent);">Generated Links:</h4>
                        <ul style="list-style: none; padding: 0;">
                `;
                
                data.links.forEach(link => {
                    linksHtml += `
                        <li style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                            <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 5px;">${link.filename}</div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <a href="${link.streaming}" target="_blank" style="color: var(--success); font-size: 0.8rem; text-decoration: none; word-break: break-all;">
                                    Download / Stream
                                </a>
                                <div style="color: var(--text-secondary); font-size: 0.7rem; cursor: pointer;" onclick="navigator.clipboard.writeText('${link.streaming}').then(() => window.notify('success', 'Copied to clipboard!'))">
                                    Copy link
                                </div>
                            </div>
                        </li>
                    `;
                });
                
                linksHtml += `</ul></div>`;
                dropZone.innerHTML = linksHtml;
                btn.style.display = 'none';
            } else {
                console.warn("No links found in response.");
                window.notify('info', 'Success, but no individual links were generated.');
            }
        } else {
            console.error("Upload failed:", data.message);
            alert('Upload failed: ' + (data.message || 'Unknown error'));
        }
    } catch (e) {
        console.error("Fetch Error:", e);
        alert('Upload failed: Network error');
    } finally {
        if (!data || !data.links || data.links.length === 0) {
            btn.disabled = false;
            btn.innerText = 'Upload';
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
});
</script>

<style>
.packs-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.pack-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.pack-actions input {
    margin:0;
    padding:0;
}

.btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 6px;
    font-size: 0.9rem;
    flex-shrink: 0;
}

/* Recent Paths Manager */
.recent-paths-manager {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 5rem;
    border: 1px solid rgba(255,255,255,0.05);
}

.recent-paths-manager h3 {
    font-size: 1rem;
    margin: 0 0 1rem 0;
    color: var(--text-secondary);
}

.recent-paths-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.recent-path-item {
    background: var(--bg-primary);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    padding: 0.4rem 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
}

.path-text {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.btn-remove-path {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.1rem;
    padding: 0;
    line-height: 1;
}

.btn-remove-path:hover {
    color: #ff4d4d;
}


.pack-card {
    position: relative;
    background: var(--bg-secondary);
    border-radius: 12px;
    /* overflow: hidden; Removed to prevent potential clipping of datalists/tooltips */
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.pack-card.loading .pack-loader-overlay {
    display: flex;
}

.pack-loader-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 10;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
    flex-direction: column;
    gap: 1rem;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.1);
    border-left-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Modal Styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

@media (max-width: 768px) {
    .modal-overlay {
        padding: 1rem;
    }
}

.modal-container {
    background: var(--bg-secondary);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 64px rgba(0,0,0,0.5);
    animation: modalAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@media (max-width: 768px) {
    .modal-container {
        max-height: 95vh;
    }
}

@keyframes modalAppear {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.05);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.modal-body {
    padding: 0;
    overflow-y: auto;
    flex: 1;
}

.batch-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.batch-table th {
    background: rgba(255,255,255,0.02);
    text-align: left;
    padding: 1rem;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    position: sticky;
    top: 0;
}

.batch-table td {
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    vertical-align: middle;
}

.batch-table tr:hover td {
    background: rgba(255,255,255,0.01);
}

.conflict-warning {
    color: #ff9800;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 500;
}

.conflict-error {
    background: rgba(255, 87, 34, 0.05);
}

.size-tag {
    font-family: monospace;
    font-size: 0.75rem;
    background: rgba(255,255,255,0.05);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
}

.btn-close-modal {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
}

.pack-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    cursor: pointer;
    transition: background 0.2s;
}

.pack-header:hover {
    background: rgba(255,255,255,0.05);
}

.pack-info h2 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    word-break: break-all;
    flex-wrap: wrap;
}

.pack-icon {
    font-size: 1.5rem;
}

.pack-meta {
    font-size: 0.875rem;
    color: var(--text-secondary);
    display: flex;
    gap: 0.5rem;
}

.btn-download-pack {
    flex-shrink: 0;
}

.pack-files {
    max-height: 2000px;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.pack-files.collapsed {
    max-height: 0;
}

.file-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
    gap: 1rem;
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
    word-break: break-word;
}

.file-size {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.download-form {
    flex-shrink: 0;
    width: 100%;
    max-width: 500px;
}
.pack-actions-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: stretch;
    width: 280px; /* Match input width preference */
    max-width: 100%;
}

/* Increased specificity to override base input[type="text"] styles */
input.pack-path-input {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem !important;
    background: var(--bg-primary);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-primary);
    border-radius: 6px;
    width: 280px !important;
    max-width: 100%;
    margin-bottom: 0 !important;
    flex-shrink: 0; /* Prevent shrinking in flex container */
    transition: border-color 0.2s;
}

input.pack-path-input:focus {
    border-color: var(--accent);
    outline: none;
}

.form-row {
    margin-bottom: 0.5rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.input-path {
    flex: 2;
    min-width: 150px;
    font-size: 0.8rem;
    padding: 0.5rem !important;
    background: var(--bg-primary);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-primary);
    border-radius: 6px;
    margin-bottom: 0 !important;
}

.rename-group {
    flex: 3;
    display: flex;
    gap: 0.3rem;
    min-width: 200px;
}

.input-rename {
    flex: 1;
    font-size: 0.8rem;
    padding: 0.5rem !important;
    background: var(--bg-primary);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-primary);
    border-radius: 6px;
    margin-bottom: 0 !important;
}

@media (max-width: 768px) {
    .pack-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .pack-actions {
        width: 100%;
        justify-content: flex-end;
    }

    .pack-actions-buttons {
        flex-wrap: wrap;
        justify-content: flex-end;
        width: 100%;
    }

    .pack-path-input {
        width: 100%;
        order: -1; /* Place input before buttons if wrapped or similar */
    }

    .file-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 1.5rem;
    }

    .download-form {
        max-width: none;
    }

    .form-row {
        flex-direction: column;
        align-items: stretch;
    }

    .input-path, .rename-group {
        width: 100%;
        min-width: 0;
    }

    .batch-table th:nth-child(4),
    .batch-table td:nth-child(4),
    .batch-table th:nth-child(5),
    .batch-table td:nth-child(5) {
        display: none; /* Hide non-essential columns on mobile */
    }
}
</style>
{% endblock %}
